<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nekotina - ADMIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #050000; color: white; overflow-x: hidden; }
        .glass { background: rgba(20, 0, 0, 0.6); border: 1px solid rgba(255, 0, 0, 0.1); backdrop-filter: blur(20px); }
        .sidebar { background: #0a0000; border-right: 1px solid #330000; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #0a0000; } ::-webkit-scrollbar-thumb { background: #450a0a; border-radius: 4px; }
        tr:hover td { background: rgba(255,0,0,0.05); }
    </style>
</head>
<body class="flex min-h-screen">

    <script>
        if(!localStorage.getItem('nekotina_admin_session')) window.location.href='admin.html';
        const API = 'https://meristic-unironical-gail.ngrok-free.dev';
        const bgAudio = new Audio('https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112191.mp3');
        bgAudio.loop = true; bgAudio.volume = 0.3;
        document.onclick = () => bgAudio.play().catch(()=>{});
        let allGroups = [];
    </script>

    <aside class="w-64 sidebar flex flex-col p-6 fixed h-full z-20">
        <div class="flex items-center gap-3 mb-10">
            <div class="w-10 h-10 bg-red-600 rounded-xl flex items-center justify-center shadow-lg shadow-red-600/20"><i data-lucide="shield-alert" class="text-white w-6 h-6"></i></div>
            <div><h1 class="font-bold text-lg font-[Fredoka]">NEKOTINA</h1><p class="text-[10px] text-red-500 font-bold tracking-widest mt-1">ADMIN</p></div>
        </div>
        <nav class="flex-1"><button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-red-900/20 text-red-400 font-bold border-l-4 border-red-600"><i data-lucide="users"></i> Gerenciar Grupos</button></nav>
        <button onclick="localStorage.removeItem('nekotina_admin_session'); location.href='admin.html'" class="flex items-center gap-3 text-red-500 font-bold mt-auto"><i data-lucide="log-out"></i> Sair</button>
    </aside>

    <main class="ml-64 flex-1 p-10">
        <header class="flex justify-between items-center mb-10">
            <h2 class="text-3xl font-extrabold text-white">Gestão Geral</h2>
            <div class="flex gap-3">
                <button onclick="addGroup()" class="bg-red-600 hover:bg-red-500 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5"></i> Novo</button>
                <button onclick="delGroups()" class="bg-white/5 hover:bg-red-900/30 text-red-400 px-4 py-3 rounded-xl font-bold border border-red-900/30"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
            </div>
        </header>

        <div class="mb-6 flex gap-4">
            <div class="flex-1 bg-white/5 rounded-xl flex items-center px-4 border border-white/10 focus-within:border-red-500">
                <i data-lucide="search" class="text-gray-500 w-5 h-5"></i>
                <input id="search" onkeyup="filter()" type="text" placeholder="Buscar..." class="bg-transparent border-none outline-none text-sm p-4 w-full text-white">
            </div>
            <div class="px-6 py-4 bg-white/5 rounded-xl border border-white/10"><span class="text-gray-400 text-sm font-bold">Total: <span id="count" class="text-white">0</span></span></div>
        </div>

        <div class="glass rounded-2xl overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-[#1a0505] text-red-300 text-xs uppercase border-b border-red-900/20">
                    <tr><th class="p-4 w-10"><input type="checkbox" onclick="toggleAll(this)" class="accent-red-600"></th><th class="p-4">Grupo / ID</th><th class="p-4">Senha</th><th class="p-4">Validade</th><th class="p-4">Plano</th><th class="p-4 text-right">Ação</th></tr>
                </thead>
                <tbody id="tbody" class="text-sm text-gray-300"></tbody>
            </table>
        </div>
    </main>

    <script>
        async function init() {
            try {
                const res = await fetch(API, { method: 'POST', body: JSON.stringify({ acao: 'admin_get_data' }) });
                const d = await res.json();
                if(d.sucesso) { allGroups = d.grupos; render(allGroups); }
            } catch(e) { Swal.fire('Erro', 'Conexão falhou', 'error'); }
            lucide.createIcons();
        }

        function render(list) {
            const tb = document.getElementById('tbody');
            document.getElementById('count').innerText = list.length;
            if(!list.length) { tb.innerHTML = '<tr><td colspan="6" class="p-10 text-center text-gray-500">Vazio.</td></tr>'; return; }
            
            tb.innerHTML = list.map(g => {
                const exp = g.expira < Date.now();
                const dias = Math.ceil((g.expira - Date.now()) / 86400000);
                return `
                <tr class="border-b border-white/5 transition-colors">
                    <td class="p-4"><input type="checkbox" class="chk accent-red-600" value="${g.id}"></td>
                    <td class="p-4">
                        <div class="font-bold text-white">${g.nome || 'Sem Nome'}</div>
                        <div class="text-[10px] text-gray-500 font-mono">${g.id}</div>
                    </td>
                    <td class="p-4"><code class="bg-white/5 px-2 py-1 rounded text-xs text-red-300">${g.senha}</code></td>
                    <td class="p-4">
                        <div class="${exp?'text-red-500 font-bold':'text-green-400'}">${exp ? 'EXPIRADO' : new Date(g.expira).toLocaleDateString('pt-BR')}</div>
                        <div class="text-[10px] text-gray-500">${exp ? 'Venceu' : dias + ' dias'}</div>
                    </td>
                    <td class="p-4"><span class="bg-white/5 px-2 py-1 rounded text-xs uppercase font-bold text-gray-400">${g.plano || 'Manual'}</span></td>
                    <td class="p-4 text-right"><button onclick="edit('${g.id}')" class="p-2 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white"><i data-lucide="edit-3" class="w-4 h-4"></i></button></td>
                </tr>`;
            }).join('');
            lucide.createIcons();
        }

        async function addGroup() {
            const { value: f } = await Swal.fire({
                title: 'Novo Grupo', background: '#110000', color: '#fff', confirmButtonColor: '#dc2626',
                html: `<input id="nid" class="w-full bg-white/5 p-3 rounded mb-2 text-white border border-red-900/30" placeholder="ID (123...g.us)"><input id="nnm" class="w-full bg-white/5 p-3 rounded mb-2 text-white border border-red-900/30" placeholder="Nome"><input id="nps" class="w-full bg-white/5 p-3 rounded mb-2 text-white border border-red-900/30" placeholder="Senha"><input id="nds" type="number" value="30" class="w-full bg-white/5 p-3 rounded text-white border border-red-900/30" placeholder="Dias">`,
                preConfirm: () => ({ id: document.getElementById('nid').value, nome: document.getElementById('nnm').value, senha: document.getElementById('nps').value || 'nekotina', expira: Date.now()+(document.getElementById('nds').value*86400000) })
            });
            if(f && f.id) { await fetch(API, { method: 'POST', body: JSON.stringify({ acao: 'admin_add_group', grupo: f }) }); init(); }
        }

        async function edit(id) {
            const g = allGroups.find(x => x.id === id);
            const dateStr = new Date(g.expira).toISOString().split('T')[0];
            const { value: f } = await Swal.fire({
                title: 'Editar', background: '#110000', color: '#fff', confirmButtonColor: '#dc2626',
                html: `<input id="enm" value="${g.nome||''}" class="w-full bg-white/5 p-3 rounded mb-2 text-white border border-red-900/30"><input id="eps" value="${g.senha}" class="w-full bg-white/5 p-3 rounded mb-2 text-white border border-red-900/30"><input id="edt" type="date" value="${dateStr}" class="w-full bg-white/5 p-3 rounded text-white border border-red-900/30">`,
                preConfirm: () => ({ id: id, nome: document.getElementById('enm').value, senha: document.getElementById('eps').value, expira: new Date(document.getElementById('edt').value).getTime() + 43200000, plano: 'Admin' })
            });
            if(f) { await fetch(API, { method: 'POST', body: JSON.stringify({ acao: 'admin_save_group', grupo: f }) }); init(); }
        }

        async function delGroups() {
            const ids = Array.from(document.querySelectorAll('.chk:checked')).map(c => c.value);
            if(!ids.length) return Swal.fire('Selecione alguém', '', 'warning');
            const res = await Swal.fire({ title: `Apagar ${ids.length}?`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#dc2626', confirmButtonText: 'Sim', background: '#110000', color: '#fff' });
            if(res.isConfirmed) { await fetch(API, { method: 'POST', body: JSON.stringify({ acao: 'admin_delete_groups', ids }) }); init(); }
        }

        function toggleAll(el) { document.querySelectorAll('.chk').forEach(c => c.checked = el.checked); }
        function filter() { const t = document.getElementById('search').value.toLowerCase(); render(allGroups.filter(g => (g.nome && g.nome.toLowerCase().includes(t)) || g.id.includes(t))); }
        window.onload = init;
    </script>
</body>
</html>
