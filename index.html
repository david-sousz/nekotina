<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nekotina SuperChat</title>
    
    <!-- Tailwind CSS (Estilo) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ãcones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Esconder barra de rolagem mas manter funÃ§Ã£o */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* AnimaÃ§Ã£o de digitaÃ§Ã£o */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* Background padrÃ£o */
        .bg-pattern {
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
            opacity: 0.05;
        }
    </style>

    <!-- ConfiguraÃ§Ã£o Tailwind para cores personalizadas -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: { 900: '#111827', 800: '#1f2937', 700: '#374151' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex flex-col overflow-hidden selection:bg-pink-500 selection:text-white">

    <!-- HEADER -->
    <header class="flex-none bg-gray-800 border-b border-gray-700 p-3 flex justify-between items-center shadow-lg z-20">
        <div class="flex items-center gap-3">
            <div class="relative group cursor-pointer">
                <div class="w-11 h-11 rounded-full bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center border-2 border-gray-700 shadow-lg shadow-pink-500/20 group-hover:scale-105 transition-transform">
                    <i data-lucide="bot" class="w-6 h-6 text-white"></i>
                </div>
                <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-gray-800 rounded-full animate-pulse"></span>
            </div>
            <div>
                <h1 class="font-bold text-lg text-white leading-tight">Nekotina</h1>
                <div class="flex items-center gap-2 text-xs text-pink-400 font-medium">
                    <i data-lucide="sparkles" class="w-3 h-3"></i>
                    <span>Multimodal AI</span>
                </div>
            </div>
        </div>
        <button onclick="clearChat()" class="p-2 hover:bg-gray-700 rounded-full text-gray-400 hover:text-red-400 transition-colors">
            <i data-lucide="trash-2" class="w-5 h-5"></i>
        </button>
    </header>

    <!-- CHAT AREA -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 bg-gray-900 relative scroll-smooth">
        <!-- Pattern Background -->
        <div class="absolute inset-0 bg-pattern pointer-events-none"></div>

        <!-- As mensagens serÃ£o inseridas aqui via JavaScript -->
        
        <!-- Loading Indicator (Escondido por padrÃ£o) -->
        <div id="loading-indicator" class="hidden flex justify-start relative z-10 animate-pulse">
            <div class="bg-gray-800 border border-gray-700 px-4 py-3 rounded-2xl rounded-tl-none flex items-center gap-2">
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-pink-500 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-pink-500 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-pink-500 rounded-full typing-dot"></div>
                </div>
                <span class="text-xs text-gray-400 font-mono ml-2">Processando...</span>
            </div>
        </div>
    </main>

    <!-- INPUT AREA -->
    <footer class="flex-none bg-gray-800 p-3 border-t border-gray-700 z-20">
        
        <!-- Preview de Anexo -->
        <div id="attachment-preview" class="hidden absolute bottom-20 left-4 bg-gray-800 p-2 rounded-xl border border-gray-600 shadow-xl items-start gap-2">
            <img id="preview-img" src="" class="w-20 h-20 object-cover rounded-lg" alt="preview">
            <button onclick="removeAttachment()" class="bg-red-500 text-white rounded-full p-1 hover:bg-red-600">
                <i data-lucide="x" class="w-3 h-3"></i>
            </button>
        </div>

        <div class="max-w-4xl mx-auto flex items-end gap-2">
            
            <!-- Input Arquivo (Escondido) -->
            <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleFileSelect(event)">

            <!-- BotÃ£o Clipe -->
            <button id="btn-attach" onclick="document.getElementById('file-input').click()" class="p-3 rounded-full bg-gray-700 text-gray-400 hover:bg-gray-600 hover:text-white transition-all">
                <i data-lucide="paperclip" class="w-5 h-5"></i>
            </button>

            <!-- Campo de Texto -->
            <div class="flex-1 bg-gray-900 border border-gray-600 rounded-2xl flex items-center px-4 py-2 focus-within:border-pink-500 focus-within:ring-1 focus-within:ring-pink-500/50 transition-all">
                <textarea id="user-input" placeholder="Mensagem ou 'Crie um gato...'" rows="1" class="w-full bg-transparent text-white placeholder-gray-500 focus:outline-none resize-none py-2 max-h-32 scrollbar-hide"></textarea>
            </div>

            <!-- BotÃ£o Enviar -->
            <button id="btn-send" onclick="handleSend()" class="bg-pink-600 hover:bg-pink-700 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg shadow-pink-600/20 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                <i data-lucide="send" class="w-5 h-5 ml-0.5"></i>
            </button>
        </div>
        
        <div class="text-center mt-2 text-[10px] text-gray-500">
            Dica: Use "Crie..." para gerar imagens ou envie uma foto para a Nekotina ver.
        </div>
    </footer>

    <!-- LÃ“GICA JAVASCRIPT -->
    <script>
        // --- VARIÃVEIS DE ESTADO ---
        let messages = [];
        let attachment = null; // { base64, mimeType }
        let isLoading = false;
        
        // --- CONFIGURAÃ‡ÃƒO ---
        const API_KEY = ""; // âš ï¸ COLOQUE SUA API KEY AQUI SE FOR RODAR LOCALMENTE
        const SYSTEM_PROMPT = `
            VocÃª Ã© a Nekotina, uma garota brasileira, jovem e zoeira.
            SUA PERSONALIDADE:
            - Fale como se estivesse no WhatsApp: use "vc", "mn", "tlgd", "kkkk", "eh".
            - Seja debochada mas Ãºtil.
            - Se receber uma imagem, comente sobre ela de forma engraÃ§ada ou analÃ­tica (se pedirem).
            - Se pedirem para CRIAR imagem, diga "PeraÃ­ que tÃ´ desenhando..." e gere.
            - HISTÃ“RICO: Lembre-se do que conversamos antes.
        `;

        // --- INICIALIZAÃ‡ÃƒO ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            addMessage('assistant', 'Opa! Nekotina na Ã¡rea ðŸ˜¼. Manda texto, foto ou pede pra eu desenhar algo! Bora?');
            
            // Auto-resize textarea
            const textarea = document.getElementById('user-input');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // Enter para enviar
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });
        });

        // --- FUNÃ‡Ã•ES DE UI ---
        function addMessage(role, text, imageUrl = null, isError = false) {
            const chatContainer = document.getElementById('chat-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            
            const div = document.createElement('div');
            div.className = `flex w-full relative z-10 ${role === 'user' ? 'justify-end' : 'justify-start'} mb-4 animate-in fade-in slide-in-from-bottom-2`;
            
            const nameColor = role === 'user' ? 'text-pink-300' : 'text-purple-400';
            const name = role === 'user' ? 'VocÃª' : 'Nekotina';
            const bgColor = role === 'user' 
                ? 'bg-pink-600 text-white rounded-tr-none' 
                : isError 
                    ? 'bg-red-900/50 border border-red-800 text-red-100 rounded-tl-none'
                    : 'bg-gray-800 text-gray-100 border border-gray-700 rounded-tl-none';

            let imageHtml = '';
            if (imageUrl) {
                imageHtml = `<div class="mb-3 rounded-lg overflow-hidden border border-white/10"><img src="${imageUrl}" class="max-w-full h-auto max-h-64 object-cover"></div>`;
            }

            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            div.innerHTML = `
                <div class="flex flex-col max-w-[85%] md:max-w-[70%] ${role === 'user' ? 'items-end' : 'items-start'}">
                    <span class="text-[10px] font-bold mb-1 px-1 ${nameColor}">${name}</span>
                    <div class="px-4 py-3 rounded-2xl shadow-md relative ${bgColor}">
                        ${imageHtml}
                        <p class="whitespace-pre-wrap text-sm md:text-base leading-relaxed">${text}</p>
                        <span class="text-[10px] block text-right mt-1 opacity-60 ${role === 'user' ? 'text-pink-100' : 'text-gray-400'}">${time}</span>
                    </div>
                </div>
            `;

            // Inserir antes do loading
            chatContainer.insertBefore(div, loadingIndicator);
            
            // Guardar no histÃ³rico
            messages.push({ role, content: text, image: imageUrl, isError });
            
            scrollToBottom();
        }

        function scrollToBottom() {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function toggleLoading(show) {
            isLoading = show;
            const loader = document.getElementById('loading-indicator');
            const btn = document.getElementById('btn-send');
            
            if (show) {
                loader.classList.remove('hidden');
                btn.disabled = true;
            } else {
                loader.classList.add('hidden');
                btn.disabled = false;
            }
            scrollToBottom();
        }

        // --- HANDLERS DE ARQUIVO ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    attachment = {
                        base64: reader.result.split(',')[1],
                        mimeType: file.type,
                        preview: reader.result
                    };
                    
                    // Show preview UI
                    const previewDiv = document.getElementById('attachment-preview');
                    const previewImg = document.getElementById('preview-img');
                    const btnAttach = document.getElementById('btn-attach');
                    
                    previewImg.src = reader.result;
                    previewDiv.classList.remove('hidden');
                    previewDiv.classList.add('flex');
                    
                    btnAttach.classList.remove('bg-gray-700', 'text-gray-400');
                    btnAttach.classList.add('bg-pink-500/20', 'text-pink-400');
                    
                    document.getElementById('user-input').placeholder = "Pergunte algo sobre a imagem...";
                };
                reader.readAsDataURL(file);
            }
        }

        function removeAttachment() {
            attachment = null;
            document.getElementById('file-input').value = '';
            
            const previewDiv = document.getElementById('attachment-preview');
            const btnAttach = document.getElementById('btn-attach');
            
            previewDiv.classList.add('hidden');
            previewDiv.classList.remove('flex');
            
            btnAttach.classList.add('bg-gray-700', 'text-gray-400');
            btnAttach.classList.remove('bg-pink-500/20', 'text-pink-400');
            
            document.getElementById('user-input').placeholder = "Mensagem ou 'Crie um gato...'";
        }

        function clearChat() {
            if(confirm("Limpar conversa?")) {
                location.reload();
            }
        }

        // --- LÃ“GICA PRINCIPAL (API) ---
        async function handleSend() {
            const inputEl = document.getElementById('user-input');
            const text = inputEl.value.trim();
            
            if ((!text && !attachment) || isLoading) return;
            
            // 1. UI Updates
            addMessage('user', text, attachment ? attachment.preview : null);
            inputEl.value = '';
            inputEl.style.height = 'auto';
            const currentAttachment = attachment; // Copy for API
            removeAttachment();
            toggleLoading(true);

            try {
                let aiResponseText = "";
                let aiResponseImage = null;

                // DETECÃ‡ÃƒO DE INTENÃ‡ÃƒO
                const isCreation = /cri|ger|desenh|faze|make|draw|generate/i.test(text) && !currentAttachment;
                const isEditing = /edit|mud|alter|transform|troc/i.test(text) && currentAttachment;

                // === ROTA 1: GERAÃ‡ÃƒO DE IMAGEM ===
                if (isCreation) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${API_KEY}`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                instances: [{ prompt: text }],
                                parameters: { sampleCount: 1 }
                            })
                        });

                        if (!response.ok) throw new Error('Falha Imagen 4.0');
                        const data = await response.json();
                        const base64Img = data.predictions?.[0]?.bytesBase64Encoded;
                        
                        if (base64Img) {
                            aiResponseImage = `data:image/png;base64,${base64Img}`;
                            aiResponseText = "TÃ¡ na mÃ£o chefia! Ficou top? ðŸ˜Ž";
                        } else {
                            throw new Error("Sem imagem");
                        }
                    } catch (e) {
                        // Fallback
                        console.warn("Usando fallback de imagem...");
                        const fallbackResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`, {
                             method: "POST",
                             headers: { "Content-Type": "application/json" },
                             body: JSON.stringify({
                                 contents: [{ parts: [{ text: "Create an image of: " + text }] }],
                                 generationConfig: { responseModalities: ["IMAGE"] }
                             })
                        });
                        const fallbackData = await fallbackResp.json();
                        const imgPart = fallbackData.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                        if(imgPart) {
                            aiResponseImage = `data:${imgPart.inlineData.mimeType};base64,${imgPart.inlineData.data}`;
                            aiResponseText = "Fiz um esboÃ§o aqui! ðŸ–Œï¸";
                        } else {
                            aiResponseText = "Putz, nÃ£o consegui desenhar hoje. ðŸ˜¿";
                        }
                    }
                }
                
                // === ROTA 2: EDIÃ‡ÃƒO ===
                else if (isEditing) {
                     const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: text },
                                    { inlineData: { mimeType: currentAttachment.mimeType, data: currentAttachment.base64 } }
                                ]
                            }],
                            generationConfig: { responseModalities: ["IMAGE"] }
                        })
                     });
                     const data = await response.json();
                     const imgPart = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                     if (imgPart) {
                         aiResponseImage = `data:${imgPart.inlineData.mimeType};base64,${imgPart.inlineData.data}`;
                         aiResponseText = "Editei aqui, vÃª se curtiu!";
                     } else {
                         aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text || "NÃ£o consegui editar visualmente.";
                     }
                }

                // === ROTA 3: CHAT TEXTO / VISÃƒO ===
                else {
                    // Prepara histÃ³rico (Ãºltimas 10 msg)
                    const historyForModel = messages
                        .slice(-10) // Pega as Ãºltimas 10 (incluindo a atual do user que acabamos de add na UI, mas nÃ£o no array messages ainda... wait, we added it to messages array inside addMessage)
                        .filter(m => m.role !== 'user' || m.content !== text) // Hack to avoid duplication if logic isn't perfect, but let's do it clean:
                        
                    // Construir payload limpo
                    const contents = [];
                    // Add previous context
                    // (Simples logic for demo: send just current message + system prompt in system instruction)
                    
                    const lastMsgParts = [{ text: text || "O que Ã© isso?" }];
                    if (currentAttachment) {
                        lastMsgParts.push({ inlineData: { mimeType: currentAttachment.mimeType, data: currentAttachment.base64 } });
                    }

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ role: 'user', parts: lastMsgParts }], // Simplified for static demo (no full history to save tokens/complexity)
                            systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] }
                        })
                    });
                    
                    const data = await response.json();
                    aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Buguei aqui...";
                }

                addMessage('assistant', aiResponseText, aiResponseImage);

            } catch (error) {
                console.error(error);
                addMessage('assistant', 'Deu ruim na conexÃ£o mn... ðŸ”Œ Tenta dnv.', null, true);
            } finally {
                toggleLoading(false);
            }
        }
    </script>
</body>
</html>
